image: {{ image }}
numcpus: {{ numcpus }}
memory: {{ memory }}
wait: true
nets:
  - name: {{ net_name }}
reservedns: {{ reservedns }}
disks:
  - size: {{ disk_size }}
cmds:
  - echo {{ user_password }} | passwd --stdin root
  - sudo apt update && sudo apt install -y apt-transport-https ca-certificates curl software-properties-common
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
  - sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu jammy stable"
  - sudo apt update && sudo apt install -y docker-ce docker-ce-cli containerd.io
  - sudo curl -L https://github.com/docker/compose/releases/latest/download/docker-compose-Linux-x86_64 -o /usr/local/bin/docker-compose || echo "docker-compose failed, continuing..."
  - sudo chmod +x /usr/local/bin/docker-compose
  - sudo ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose
  - cd /root/ && curl -OL https://raw.githubusercontent.com/tosin2013/kcli-pipelines/main/harbor/harbor.sh
  - chmod +x /root/harbor.sh
  - echo "bash -xe /root/harbor.sh {{ domain }} {{ harbor_version }} {{ aws_access_key_id }}  {{ aws_secret_access_key }} {{ email }}" > /root/init-harbor.sh
  - chmod +x /root/init-harbor.sh &&  bash -xe /root/init-harbor.sh | tee /var/log/harbor_install.log   